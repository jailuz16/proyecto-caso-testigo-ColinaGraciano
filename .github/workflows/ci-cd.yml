name: CI/CD Pipeline - Calculadora 

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Ejecutar diariamente para generar builds
    - cron: '0 12 * * *'

jobs:
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        
    - name: Run unit tests
      run: |
        cd backend
        pytest test_main.py -v
        
    - name: Run integration tests
      run: |
        cd backend
        # Iniciar servidor en background
        uvicorn app.main:app --host 0.0.0.0 --port 8000 &
        sleep 10
        pytest test_integration_final.py -v
        
    - name: Generate coverage report
      run: |
        cd backend
        pytest --cov=app --cov-report=xml --cov-report=html
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
        flags: backend

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Run tests
      run: |
        cd frontend
        npm test -- --watchAll=false
        
    - name: Build application
      run: |
        cd frontend
        npm run build

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: Run security audit
      run: |
        cd backend
        pip install safety
        safety check -r requirements.txt --output text || true

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install backend dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        pip install selenium webdriver-manager
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Start backend server
      run: |
        cd backend
        uvicorn app.main:app --host 0.0.0.0 --port 8000 &
        
    - name: Start frontend server
      run: |
        cd frontend
        npm run dev &
        sleep 15
        
    - name: Install Chrome for Selenium
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser
        
    - name: Run E2E tests
      run: |
        cd tests/e2e
        python -m pytest test_e2e_selenium.py -v --tb=short

  deploy-demo:
    name: Deploy to Demo
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, e2e-tests]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: Deploy simulation
      run: |
        echo "ğŸš€ Simulando despliegue a ambiente de demo"
        echo "âœ… Backend desplegado en puerto 8000"
        echo "âœ… Frontend desplegado en puerto 3000"
        echo "âœ… Build #${{ github.run_number }} completado exitosamente"

  success-metrics:
    name: Success Metrics
    runs-on: ubuntu-latest
    needs: [deploy-demo]
    if: always()
    
    steps:
    - name: Report success
      run: |
        echo "ğŸ“Š MÃ‰TRICAS DEL BUILD"
        echo "======================"
        echo "âœ… Build Number: ${{ github.run_number }}"
        echo "âœ… Commit: ${{ github.sha }}"
        echo "âœ… Branch: ${{ github.ref }}"
        echo "âœ… Timestamp: $(date)"
        echo "======================"
        
    - name: Create build badge
      run: |
        echo "ğŸ›¡ï¸ Creando badge de build exitoso"
        # Esto simularÃ­a actualizar un badge
        echo "Build #${{ github.run_number }} - âœ… SUCCESS" >> build-status.txt